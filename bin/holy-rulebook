#!/bin/bash
set -e
cd "$(dirname "${0}")/.."

PATH="${PATH}:node_modules/.bin"
export APP_ENV='local'

## Default task
task_default() {
  export APP_ENV='production'
  yarn install
  exec node --experimental-modules src/http/server.mjs "${@}"
}

## Development server
task_serve() {
  yarn install
  rm -rf public/bundles
  exec webpack-dev-server --inline --hot
}

## Build the client bundle
task_build() {
  export APP_ENV='production'
  yarn install
  exec webpack --progress
}

## Clean all build artifacts
task_clean() {
  rm -rf public/bundles node_modules
  exit ${?}
}

## Parse args
[[ ${1} == '--dev' ]] && task_serve
[[ ${1} == '--build' ]] && task_build
[[ ${1} == '--clean' ]] && task_clean

task_default
