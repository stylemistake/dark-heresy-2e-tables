#!/bin/bash
set -e
cd "$(dirname "${0}")/.."

PATH="${PATH}:node_modules/.bin"
export APP_ENV='local'

task_serve() {
  yarn install
  rm -rf public/bundles
  webpack-dev-server --progress --inline --hot
}

task_build() {
  export APP_ENV='production'
  yarn install
  webpack --progress
}

## Development server
if [[ ${1} == '--dev' ]]; then
  task_serve
  exit ${?}
fi

## Run a production build
if [[ ${1} == '--build' ]]; then
  task_build
  exit ${?}
fi

## Clean build artifacts
if [[ ${1} == '--clean' ]]; then
  rm -rf public/bundles node_modules
  exit ${?}
fi

## Check if we need to build the bundle before running the server
[[ ! -d public/bundles ]] && task_build

## Launch the server
export APP_ENV='production'
yarn install --production
exec node src/http/server.js "${@}"
